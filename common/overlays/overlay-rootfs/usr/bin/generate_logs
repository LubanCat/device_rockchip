#!/bin/sh

LOG_DIR=$(mktemp -dt log.XXXXXX)
LOG_TARBALL=/tmp/log-$(date +%m%d%y-%H%M%S).tar.gz

cd "$LOG_DIR"

date > timestamp.txt

(top -Hbn 1 2>/dev/null || top -bn 1) > top.txt
(ps aux 2>/dev/null || ps) > ps.txt
dmesg -c > dmesg.txt

if [ -w /proc/sysrq-trigger ]; then
	for s in l m q t w; do
		echo $s > /proc/sysrq-trigger
	done
	dmesg > sysrq.txt
fi

if type modetest >/dev/null 2>/dev/null; then
	modetest -a > modetest.txt

	if type kmsgrab >/dev/null 2>/dev/null; then
		PLANES="$(modetest -p | grep -A 1000 "^P" | grep -o "^[0-9]*")"
		for p in $PLANES; do
			kmsgrab --plane $p >plane_$p.txt 2>plane_$p.raw
		done
	fi
fi

if type lsof >/dev/null 2>/dev/null; then
	lsof > lsof.txt
fi

df > df.txt

if type lsblk >/dev/null 2>/dev/null; then
	lsblk > lsblk.txt
fi

if [ -d /info ]; then
	cp -rL /info/* . 2>/dev/null
fi

if [ -d /etc/generate_logs.d ]; then
	for s in $(find /etc/generate_logs.d/); do
		$s "$LOG_DIR"
	done
fi

tar czf "$LOG_TARBALL" .

cd /
rm -rf "$LOG_DIR"

echo "Log files zipped to $LOG_TARBALL"
